close all;
clear;

% -------------------------- SET THE PHYSICS -------------------------
model = ModelType(["SinglePhaseFlow_FVTPFA","Poromechanics_FEM"]);
%
% ----------------------- SIMULATION PARAMETERS ----------------------
fileName = "simParam.dat";
simParam = SimulationParameters(fileName);
%
% ------------------------------  MESH -------------------------------
% Create the Mesh object
topology = Mesh();
%
% Set the input file name
fileName = 'Column.msh';
% Import the mesh data into the Mesh object
topology.importGMSHmesh(fileName);
%
%----------------------------- MATERIALS -----------------------------
%
% Set the input file name
fileName = 'materialsList.dat';
%
% Create an object of the Materials class and read the materials file
mat = Materials(model,fileName);
%
%------------------------------ ELEMENTS -----------------------------
%
GaussPts = Gauss(12,2,3);
% Create an object of the "Elements" class and process the element properties
elems = Elements(topology,GaussPts);

%saving z_vector coordinates for analytical solution calculation
nodez = topology.coordinates(:,3);
if isFVTPFABased(model,'Flow')
    cellz = elems.cellCentroid(:,3);
else
    cellz = nodez;
end

%calling analytical solution script
%Terzaghi_analytical(topology, mat, 10)

% Create an object of the "Faces" class and process the face properties
faces = Faces(model, topology);
%
% Wrap Mesh, Elements and Faces objects in a structure
grid = struct('topology',topology,'cells',elems,'faces',faces);
%
% Degree of freedom manager 
%fname = 'dof.dat';
dofmanager = DoFManager_new(topology,model);

%------------------------ BOUNDARY CONDITIONS ------------------------
% Write BC files (use user friendly function to write them)
F = -10; % vertical force
% Top no flow
writeBCfiles('BCs/dirFlowTop.dat','SurfBC','Dir','Flow','NoFlowTop',0,0,topology,2);
% Top load
writeBCfiles('BCs/newPorotop.dat','SurfBC','Neu',{'Poro','z'},'TopLoad',0,F,topology,2);
% Lateral roller
writeBCfiles('BCs/dirPoroLatY.dat','NodeBC','Dir',{'Poro','y'},'LatFixedY',0,0,topology,3);
writeBCfiles('BCs/dirPoroLatX.dat','NodeBC','Dir',{'Poro','x'},'LatFixedX',0,0,topology,4);
% Bottom fixed
writeBCfiles('BCs/dirPoroBottom.dat','NodeBC','Dir',{'Poro','x','y','z'},'BotFixed',0,0,topology,1);

% Collect input files input file
fileName = ["dir_BC_flow_tetra.dat","dir_BCSurf_poro_tetra.dat","neuSurf_BC_poro_tetra.dat"];
%


%file = 'initialconditions';
if isFEMBased(model,'Flow')
    file = ["iniDisp.dat","iniPressureFEM.dat"];
else
    file = ["iniDisp.dat","iniPressure.dat"];
end

% Create and set the print utility
printUtils = OutState(model,mat,grid,'outTime.dat','printOn');
%

%
% ---------------------------- SOLUTION -------------------------------
% Create object handling construction of Jacobian and rhs of the model
linSyst = Discretizer(model,simParam,dofmanager,grid,mat,GaussPts);

% Build a structure storing variable fields at each time step
state = linSyst.setState();
% Print model initial state
%printUtils.printState(state);


% Create an object of the "Boundaries" class 
bound = Boundaries(fileName,model,grid);

% In this version of the code, the user can assign initial conditions only
% manually by directly modifying the entries of the state structure. 
% In this example, we use a user defined function to apply Terzaghi initial
% conditions to the state structure
applyTerzaghiIC(state);

% Built-in fully implict solution scheme 
% The modular structure of the discretizer class allow the user to design
% its own version of the solution scheme
NSolv = NonLinearSolver(model,simParam,dofmanager,grid,mat,bound,printUtils,resState,linSyst,GaussPts);
%
% Solve the problem
[simState] = NSolv.NonLinearLoop();
%
% Finalize the print utility
printUtils.finalize()
%
%%
% -------------------------- BENCHMARK ------------------------------

%Post processing using MAT-FILE 
%nodes vector contain list of nodes along vertical axis (with x,y=0) 
nodesU = find(topology.coordinates(:,1)+topology.coordinates(:,2)==0);
[~,ind] = sort(topology.coordinates(nodesU,3));
nodesU = nodesU(ind);

load("Terzaghi_Analytical.mat");


% elem vector containing elements centroid along vertical axis
if isFEMBased(model,'Flow')
    nodesP = nodesU;
else
    nodesP = find(elems.cellCentroid(:,1) + elems.cellCentroid(:,2) < 0.51);
    [~,ind] = sort(elems.cellCentroid(nodesP,3));
    nodesP = nodesP(ind);
end


%Getting pressure and displacement solution for specified time from MatFILE
press = printUtils.m.expPress;
disp = printUtils.m.expDispl;
pressplot = press(nodesP,2:end);
dispplot = disp(3*nodesU,2:end);


%Plotting solution
if isFVTPFABased(model,'Flow')
    ptsY = elems.cellCentroid(nodesP,3);
else
    ptsY = topology.coordinates(nodesP,3);
end
figure(1)
plotObj1 = plot(pressplot,ptsY,'k.', 'LineWidth', 1, 'MarkerSize', 15);
hold on
plotObj2 = plot(pressplot(nodesP,:),ptsY,'k', 'LineWidth', 1);
grid on
xlabel('Pressure (kPa)')
ylabel('z (m)')
legend([plotObj1(1),plotObj2(1)],{'Numerical','Analytical'}, 'Location', 'northeast');
%title('h = 0.5 m \Delta t = 0.1 s \theta = 1.0')
axis tight
xlim([0 10.2])

set(findall(gcf, 'type', 'text'), 'FontName', 'Liberation Serif','FontSize', 14);
a = get(gca,'XTickLabel');
set(gca,'XTickLabel',a,'FontName', 'Liberation Serif','FontSize', 12)
% export figure with quality
stmp = strcat('C:\Users\Moretto\Documents\PHD\GReS\Reports\Presentation\Images', 'Terzaghi_pressure', '.png');
exportgraphics(gcf,stmp,'Resolution',400)

figure(2)
plotObj1 = plot(-dispplot,topology.coordinates(nodesU,3),'k.', 'LineWidth', 1, 'MarkerSize', 15);
hold on
plotObj2 = plot(ufem(nodesU,:),topology.coordinates(nodesU,3),'k',  'LineWidth', 1);
grid on
xlabel('Vertical displacements (mm)')
ylabel('z (m)')
%title('h = 0.5 m \Delta t = 0.1 s \theta = 1.0')
legend([plotObj1(1),plotObj2(1)],{'Numerical','Analytical'}, 'Location', 'southeast');

set(findall(gcf, 'type', 'text'), 'FontName', 'Liberation Serif', 'FontSize', 14);
a = get(gca,'XTickLabel');
set(gca,'XTickLabel',a,'FontName', 'Liberation Serif', 'FontSize', 12)
% export figure with quality
stmp = strcat('C:\Users\Moretto\Documents\PHD\GReS\Reports\Presentation\Images\', 'Terzaghi_disp', '.png');
exportgraphics(gcf,stmp,'Resolution',400)
%%
%Checking error norm 
% Compute the volume connected to each node
volNod = zeros(topology.nNodes,1);
if any(topology.cellVTKType == 12)
  N1 = getBasisFinGPoints(elems.hexa);
end
for el=1:topology.nCells
  top = topology.cells(el,1:topology.cellNumVerts(el));
  if topology.cellVTKType(el) == 10 % Tetra
    volNod(top) = volNod(top) + elems.vol(el)/topology.cellNumVerts(el);
  elseif topology.cellVTKType(el) == 12 % Hexa
    dJWeighed = getDerBasisFAndDet(elems.hexa,el,3);
    volNod(top) = volNod(top)+ N1'*dJWeighed';
  end
end


% errpress = sqrt(sum((analpress - press(:,2:end)).^2));
% normanal = sqrt(sum(analpress.^2));
% errRelpress = errpress./normanal;

%pressure_error
errpress2 = (pfem - press(:,2:end)).^2;
errNormpressure = sqrt(errpress2'*elems.vol);

%displacement_error
errdisp2 = (ufem - disp(3:3:end,2:end)).^2;
errNormdisp = sqrt(errdisp2'*volNod);